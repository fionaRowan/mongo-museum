<!doctype html>
<html>
  <body>
    <svg></svg>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script type="text/javascript">
      window.onload = function() {
        const data = {
          groups: [
            {
              name: 'shard1',
              processes: [
                {
                  name: 'primary',
                  shape: 'database',
                }
              ]
            },
            {
              name: 'config',
              processes: [
                {
                  name: 'primary',
                  shape: 'database',
                }
              ]
            },
            {
              name: 'mongos1',
              processes: [
                {
                  name: 'mongos',
                  shape: 'database',
                  services: [
                    {
                      name: 'CatalogCache',
                    },
                    {
                      name: 'AsyncRequestsSender'
                    }
                  ]
                }
              ]
            },
          ],
        };

        const repelGroups = generateRepelGroups();
        d3.select('svg').data([data]).call(repelGroups);
      };

function generateRepelGroups() {
  let height = 500;
  let width = 500;

  function repelGroups(selection) {
    selection.each(function(data) {
      const svg = d3.select(this);

      svg.attr('height', height)
        .attr('width', width);

      let groups = svg.selectAll('g.repel-group')
        .data(data.groups);

      groups.exit()
        .remove();

      groups = groups.enter()
        .append('g')
        .attr('class', 'repel-group')
        .merge(groups);


      const processes = generateProcesses()
      groups.call(processes);
    });
  }

  return repelGroups;
};

function generateProcesses() {
  function processes(selection) {
    selection.each(function(data) {
      const group = d3.select(this);

      let processGroups = group.selectAll('g.process')
        .data(data.processes);

      processGroups.exit().remove();

      const enterProcessGroups = processGroups.enter()
        .append('g')
        .attr('class', 'process');

      enterProcessGroups.append('rect')
        .attr('height', 100)
        .attr('width', 100)
        .attr('stroke', 'black')
        .attr('x', 1)
        .attr('y', 1)
        .attr('fill', 'none')
        .attr('stroke-width', 1);

      processGroups = processGroups.merge(enterProcesses);
      // const services = generateServices();
      // processGroups.call(services);
    });
    return repelGroup;
  }

  return processes;
}
    </script>
  </body>
</html>
